---
title: "Praktikum 4"
author: "Muhammad Rayhan Faridh"
date: "2024-10-15"
output: word_document
---

Studi Kasus
Data diambil dari majalah Motor Trend US 1974, dan terdiri dari konsumsi bahan bakar dan beberapa aspek desain dan kinerja mobil untuk 32 mobil. Seorang designer mempunyai target suatu mobil ideal adalah mempunyai karakteristik konsumsi bahan bakar 20 mpg, mesin 200 cubic inchi (1 cubic inchi = 16.387 cc), kekuatan 150 hp, dan berat 3000 pon, H0: μ = (20,200,150,3). Untuk menguji hipotesis tersebut seorang peneliti mengambil sampel sebanyak 32 mobil.

Hipotesis
H0: μ = 0 
H1: μ ≠ 0

Asumsi
- Sample acak sebanyak n observasi X1, X2,..., Xn diambil dari populasi berdistribusi multivariate normal Np
- Matriks kovarians tidak diketahui

Pertanyaan:
Hitunglah vektor rata-rata sampel X dan matriks kovarians sampel S untuk menduga vektor rata-rata dan matriks kovarians populasi!


A. Uji T2 Hotelling (Matriks kovarians tidak diketahui)

Statistik uji: T^2

```{r}
#Menghitung statistik uji T2 Hotelling
T.test <- function(X, mu=0){
            X <- as.matrix(X)
            n <- nrow(X)
            p <- ncol(X)
            df2 <- n - p
          
          if(df2 < 1L) 
            stop("Need nrow(X) > ncol(X).")
          if(length(mu) != p) 
            mu <- rep(mu[1], p)
            
            xbar <- colMeans(X)
            S <- cov(X)

          T2 <- n * t(xbar - mu) %*% solve(S) %*% (xbar - mu)
          Fstat <- T2 / (p * (n-1) / df2)
          pval <- 1 - pf(Fstat, df1=p, df2=df2)
          data.frame(T2=as.numeric(T2), Fstat=as.numeric(Fstat),
          df1=p, df2=df2, p.value=as.numeric(pval), row.names="")
      }
```

```{r}
#Impor data mtcars
data(mtcars)
X <- mtcars[,c("mpg","disp","hp","wt")]
```

```{r}
#Hitung vektor rata-rata sampel x
xbar <- colMeans(X) 
xbar
```

```{r}
#Hitung rata-rata populasi berdasarkan hipotesis awal
mu<-c(20,200,150,3)

#Hitung statistik uji T2 Hotelling (F.hitung dan p-value)
T.test(X, mu)
```

```{r}
#Untuk menghitung statistik uji dan p-value dapat digunakan juga fungsi “lm”
y <- as.matrix(X) -
matrix(c(20,200,150,3),nrow(X),ncol(X),byrow=T)

model1<-anova(lm(y ~ 1))
model1
```

```{r}
#Hitung nilai kritis penolakan H0
#Banyak observasi
n <- nrow(X) 

#Banyak variabel
p <- ncol(X)

alpha <- 0.05
C2 <- (n - 1) * p * qf(1-alpha, df1=p, df2=n-p)/(n-p)
C2
```
Berdasarkan output di atas, didapatkan vektor rata-rata sampel dari p = 4 variable adalah:
xT = 20.09062, 230.72188 , 146.68750, 3.21725

Jika (α =  0.05), nilai C2 = (n-1)p/(n-p)*F(p,n-p); 1-α = 12.01948.
Nilai T2 Hotelling diperoleh sebesar 10.78587.
Oleh karena nilai T2 Hotelling < C2 atau p-value = 0.07058 > (α = 0.05) 

Kesimpulan: gagal tolak H0.
Artinya, berdasarkan data sampel yang ada, desain mobil sudah sesuai target.

```{r}
library(car)

#Membuat Confidence Region Ellipsoid
n <- nrow(X)
p <- ncol(X)
xbar <- colMeans(X)
S <- cov(X)

alpha<-0.05
tconst <- sqrt((p/n)*((n-1)/(n-p)) * qf(1-alpha,p,n-p))

id <- c(1,2)

plot(ellipse(center=xbar[id], shape=S[id,id], radius=tconst, draw=F),type="n", xlab="mpg", ylab="disp")

lines(ellipse(center=xbar[id], shape=S[id,id], radius=tconst, lwd=3), xlab="mpg", ylab="disp")

points(20,200,col="red", pch=16)
text(20.5,200,expression(mu[0]))
text(xbar[1]+0.5,xbar[2],expression(bar(x)))
```

Karena mu_0 berada di dalam ellipsoid, maka gagal tolak h0, maka belum terdapat cukup bukti untuk membuktikan bahwa rata-rata kedua kelompok berbeda.

```{r}
#Menghitung pendugaan interval (CI)
T.ci <- function(mu, Sigma, n, avec=rep(1,length(mu)), level=0.95) {
    p <- length(mu)
    
    #validasi input
    if(nrow(Sigma)!=p) stop("Need length(mu) == nrow(Sigma).")
    if(ncol(Sigma)!=p) stop("Need length(mu) == ncol(Sigma).")
    if(length(avec)!=p) stop("Need length(mu) == length(avec).")
    if(level <=0 | level >= 1) stop("Need 0 < level < 1.")

    #perhitungan nilai CI
    cval <- qf(level, p, n-p) * p * (n-1) / (n-p)
    zhat <- crossprod(avec, mu)
    zvar <- crossprod(avec, Sigma %*% avec) / n
    const <- sqrt(cval * zvar)

    c(lower = zhat - const, upper = zhat + const)
}

S<-cov(X)
n <- nrow(X)
p <- ncol(X)

#CI untuk mu_0 mpg
T.ci(mu=xbar, Sigma=S, n=n, avec=c(1,0,0,0))

#CI untuk mu_0 disp
T.ci(mu=xbar, Sigma=S, n=n, avec=c(0,1,0,0))

#CI untuk mu_0 hp
T.ci(mu=xbar, Sigma=S, n=n, avec=c(0,0,1,0))

#CI untuk mu_0 wt
T.ci(mu=xbar, Sigma=S, n=n, avec=c(0,0,0,1))
```

```{r}
#Perbandingan CI T2 Hotelling, t-univariat dan Bonferroni
TCI <- tCI <- bon <- NULL
alpha1 <- 1-0.05
alpha2 <- 1-(0.05/2)
alpha3 <- 1 - 0.05/(2*4)

for(k in 1:4){
  avec <- rep(0, 4)
  avec[k] <- 1
  
  TCI <- c(TCI, T.ci(xbar, S, n, avec,level=alpha1))
  tCI <- c(tCI, 
          xbar[k] - sqrt(S[k,k]/n) * qt(alpha2, df=n-1),
          xbar[k] + sqrt(S[k,k]/n) * qt(alpha2, df=n-1)) #CI t-univariate
  
  bon <- c(bon,
          xbar[k] - sqrt(S[k,k]/n) * qt(alpha3, df=n-1),
          xbar[k] + sqrt(S[k,k]/n) * qt(alpha3, df=n-1)) #CI Bonferroni
}

rtab <- rbind(TCI, tCI, bon)
round(rtab, 2)
```

B. Data dengan Sampel Besar

Statistik uji: Z^2

```{r}
#Impor data (Data sama dengan kasus A)
data(mtcars)
X <- mtcars[,c("mpg","disp","hp","wt")]
```
```{r}
#Hitung statistik uji Z^2 dan simultaneous confidence interval
Z2.test <- function(X, mu=0, asymp=FALSE){
              X <- as.matrix(X)
              n <- nrow(X)
              p <- ncol(X)
              df2 <- n - p
              
            if(df2 < 1L) 
              stop("Need nrow(X) > ncol(X).")
            if(length(mu) != p) 
              mu <- rep(mu[1], p)

              xbar <- colMeans(X)
              S <- cov(X)

              Z2 <- n * t(xbar - mu) %*% solve(S) %*% (xbar - mu)
              Fstat <- Z2 / (p * (n-1) / df2)
              
            if(asymp){
              pval <- 1 - pchisq(Z2, df=p)
              } else {
              pval <- 1 - pf(Fstat, df1=p, df2=df2)
              }

#CI untuk sample besar
chi <- NULL
  for(k in 1:p){
    chi <- c(chi, 
             xbar[k] - sqrt(S[k,k]/n) * sqrt(qchisq(0.95, df=p)),
             xbar[k] + sqrt(S[k,k]/n) * sqrt(qchisq(0.95, df=p)))
}
              
data.frame(Z2=as.numeric(Z2), Fstat=as.numeric(Fstat), df1=p, df2=df2, p.value=as.numeric(pval), asymp=asymp, row.names="")
}
```


```{r}
#Definisikan rata-rata populasi berdasarkan H0
mu<-c(20,200,150,3)

#Hitung statistik uji
Z2.test(X, mu=mu,asymp=TRUE)
```

```{r}
#Hitung nilai kritis penolakan H0
#banyaknya observasi
n <- nrow(X)

#banyaknya variabel
p <- ncol(X) 

alpha <- 0.05
C2 <- qchisq(1-alpha, df=p)
C2
```
Berdasarkan output di atas, didapatkan nilai statistik uji berdasarkan H0
adalah Z2 = 10.78587

Jika (α = 0.05), nilai kritisnya adalah c2 = 2p; 1-α = 9.487729
Oleh karena nilai Z2 > 2p;1-α atau p-value =0.0290789<α=0.05

Kesimpulan: tolak H0.
Artinya, berdasarkan data sampel yang ada
jika jumlah sampel dianggap besar, desain mobil belum mencapai target.

```{r}
#Perbandingan Simultanuous CI sampel kecil (TCI, tCI, bon) dengan CI sampel besar (chi)
TCI <- tCI <- bon <- chi <- NULL
alpha1 <- 1-0.05
alpha2 <- 1-(0.05/2)
alpha3 <- 1 - 0.05/(2*4)

for(k in 1:4){
  avec <- rep(0, 4)
  avec[k] <- 1

  TCI <- c(TCI, T.ci(xbar, S, n, avec,level=alpha1))
  tCI <- c(tCI,
          xbar[k] - sqrt(S[k,k]/n) * qt(alpha2, df=n-1),
          xbar[k] + sqrt(S[k,k]/n) * qt(alpha2, df=n-1))

  bon <- c(bon,
          xbar[k] - sqrt(S[k,k]/n) * qt(alpha3, df=n-1),
          xbar[k] + sqrt(S[k,k]/n) * qt(alpha3, df=n-1))

  chi <- c(chi,
          xbar[k] - sqrt(S[k,k]/n) * sqrt(qchisq(0.95, df=p)),
          xbar[k] + sqrt(S[k,k]/n) * sqrt(qchisq(0.95, df=p)))
}

rtab <- rbind(TCI, tCI, bon,chi)
round(rtab, 2)
```

Terlihat untuk simultanueous CI dengan sampel besar menunjukkan hasil keputusan yang berbeda (tidak konsisten), artinya data n=32 belum cukup dikatakan sampel besar. 
